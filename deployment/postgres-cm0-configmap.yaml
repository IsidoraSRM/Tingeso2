apiVersion: v1
data:
  init-db.sh: "#!/bin/bash\nset -e\n\n# 1) crear las bases y los privilegios\nfor db in $(echo $POSTGRES_MULTIPLE_DATABASES | tr ',' ' '); do\n  psql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" <<-EOSQL\n    CREATE DATABASE $db;\n    GRANT ALL PRIVILEGES ON DATABASE $db TO $POSTGRES_USER;\nEOSQL\ndone\n\n# 2) crear tablas e insertar datos\n\n## 2.1) ms1db: Tariff\npsql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" --dbname ms1db <<-EOSQL\nCREATE TABLE IF NOT EXISTS Tariff (\n  id SERIAL PRIMARY KEY,\n  laps           INTEGER NOT NULL,\n  max_minutes    INTEGER NOT NULL,\n  price          BIGINT NOT NULL,\n  total_duration INTEGER NOT NULL\n);\nINSERT INTO Tariff (laps, max_minutes, price, total_duration) VALUES\n  (10, 10, 15000, 30),\n  (15, 15, 20000, 35),\n  (20, 20, 25000, 40)\nON CONFLICT DO NOTHING;\nEOSQL\n\n## 2.2) ms2db: group_size_dsc\npsql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" --dbname ms2db <<-EOSQL\nCREATE TABLE IF NOT EXISTS group_size_dsc (\n  id_group_size_dsc   SERIAL PRIMARY KEY,\n  min_group_size      INTEGER NOT NULL,\n  max_group_size      INTEGER NOT NULL,\n  discount_percentage NUMERIC(5,2) NOT NULL\n);\nINSERT INTO group_size_dsc (min_group_size, max_group_size, discount_percentage) VALUES\n  (1,  2,  0.0),\n  (3,  5, 10.0),\n  (6, 10, 20.0),\n  (11,15, 30.0)\nON CONFLICT DO NOTHING;\nEOSQL\n\n## 2.3) ms3db: frequency_dsc\npsql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" --dbname ms3db <<-EOSQL\nCREATE TABLE IF NOT EXISTS frequency_dsc (\n  id_frequency_dsc    SERIAL PRIMARY KEY,\n  frequency_type      VARCHAR(50) NOT NULL,\n  min_frequency       INTEGER NOT NULL,\n  max_frequency       INTEGER NOT NULL,\n  discount_percentage NUMERIC(5,2) NOT NULL\n);\nINSERT INTO frequency_dsc (frequency_type, min_frequency, max_frequency, discount_percentage) VALUES\n  ('Muy frecuente',   7, 1000000, 30.0),\n  ('Frecuente',       5,       6, 20.0),\n  ('Regular',         2,       4, 10.0),\n  ('No frecuente',    0,       1,  0.0)\nON CONFLICT DO NOTHING;\nEOSQL\n\n## 2.4) ms4db: SpecialDay\npsql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" --dbname ms4db <<-EOSQL\nCREATE TABLE IF NOT EXISTS special_day (\n  id_special_day    SERIAL PRIMARY KEY,\n  name            VARCHAR(100) NOT NULL,\n  date            DATE           NOT NULL,\n  special_discount DOUBLE PRECISION NOT NULL\n);\n\nINSERT INTO special_day (name, date, special_discount) VALUES\n  -- ========== AÑO 2025 ==========\n  ('Año Nuevo', '2025-01-01', 1.3),\n  ('Viernes Santo', '2025-04-18', 1.4),\n  ('Sábado Santo', '2025-04-19', 1.2),\n  ('Día del Trabajo', '2025-05-01', 1.3),\n  ('Día de las Glorias Navales', '2025-05-21', 1.2),\n  ('Día del Padre', '2025-06-15', 0.5),\n  ('San Pedro y San Pablo', '2025-06-29', 1.0),\n  ('Día de la Virgen del Carmen', '2025-07-16', 1.1),\n  ('Fiestas Patrias', '2025-09-18', 1.5),\n  ('Día de las Glorias del Ejército', '2025-09-19', 1.4),\n  ('Encuentro de Dos Mundos', '2025-10-12', 1.0),\n  ('Día de las Iglesias Evangélicas', '2025-10-31', 1.0),\n  ('Día de Todos los Santos', '2025-11-01', 1.2),\n  ('Inmaculada Concepción', '2025-12-08', 1.1),\n  ('Navidad', '2025-12-25', 1.5),\n  ('Día de San Valentín', '2025-02-14', 0.8),\n  ('Día de la Madre', '2025-05-10', 0.7),\n\n  -- ========== AÑO 2026 ==========\n  ('Año Nuevo', '2026-01-01', 1.3),\n  ('Viernes Santo', '2026-04-03', 1.4),\n  ('Sábado Santo', '2026-04-04', 1.2),\n  ('Día del Trabajo', '2026-05-01', 1.3),\n  ('Día de las Glorias Navales', '2026-05-21', 1.2),\n  ('Día del Padre', '2026-06-21', 0.5),\n  ('San Pedro y San Pablo', '2026-06-29', 1.0),\n  ('Día de la Virgen del Carmen', '2026-07-16', 1.1),\n  ('Fiestas Patrias', '2026-09-18', 1.5),\n  ('Día de las Glorias del Ejército', '2026-09-19', 1.4),\n  ('Encuentro de Dos Mundos', '2026-10-12', 1.0),\n  ('Día de las Iglesias Evangélicas', '2026-10-31', 1.0),\n  ('Día de Todos los Santos', '2026-11-01', 1.2),\n  ('Inmaculada Concepción', '2026-12-08', 1.1),\n  ('Navidad', '2026-12-25', 1.5),\n  ('Aniversario Local', '2026-08-15', 0.6),\n\n  -- ========== AÑO 2027 ==========\n  ('Año Nuevo', '2027-01-01', 1.3),\n  ('Viernes Santo', '2027-03-26', 1.4),\n  ('Sábado Santo', '2027-03-27', 1.2),\n  ('Día del Trabajo', '2027-05-01', 1.3),\n  ('Día de las Glorias Navales', '2027-05-21', 1.2),\n  ('Día del Padre', '2027-06-20', 0.5),\n  ('San Pedro y San Pablo', '2027-06-29', 1.0),\n  ('Día de la Virgen del Carmen', '2027-07-16', 1.1),\n  ('Fiestas Patrias', '2027-09-18', 1.5),\n  ('Día de las Glorias del Ejército', '2027-09-19', 1.4),\n  ('Encuentro de Dos Mundos', '2027-10-12', 1.0),\n  ('Día de las Iglesias Evangélicas', '2027-10-31', 1.0),\n  ('Día de Todos los Santos', '2027-11-01', 1.2),\n  ('Inmaculada Concepción', '2027-12-08', 1.1),\n  ('Navidad', '2027-12-25', 1.5),\n\n  -- ========== AÑO 2028 ==========\n  ('Año Nuevo', '2028-01-01', 1.3),\n  ('Viernes Santo', '2028-04-14', 1.4),\n  ('Sábado Santo', '2028-04-15', 1.2),\n  ('Día del Trabajo', '2028-05-01', 1.3),\n  ('Día de las Glorias Navales', '2028-05-21', 1.2),\n  ('Día del Padre', '2028-06-18', 0.5),\n  ('San Pedro y San Pablo', '2028-06-29', 1.0),\n  ('Día de la Virgen del Carmen', '2028-07-16', 1.1),\n  ('Fiestas Patrias', '2028-09-18', 1.5),\n  ('Día de las Glorias del Ejército', '2028-09-19', 1.4),\n  ('Encuentro de Dos Mundos', '2028-10-12', 1.0),\n  ('Día de las Iglesias Evangélicas', '2028-10-31', 1.0),\n  ('Día de Todos los Santos', '2028-11-01', 1.2),\n  ('Inmaculada Concepción', '2028-12-08', 1.1),\n  ('Navidad', '2028-12-25', 1.5)\nON CONFLICT DO NOTHING;\nEOSQL\n\n# Si necesitas datos base para ms5db–ms7db, añade aquí más bloques:\n# ## 2.5) ms5db: … \n# psql … --dbname ms5db <<-EOSQL\n# INSERT INTO … ON CONFLICT DO NOTHING;\n# EOSQL"
kind: ConfigMap
metadata:
  annotations:
    use-subpath: "true"
  labels:
    io.kompose.service: postgres
  name: postgres-cm0
